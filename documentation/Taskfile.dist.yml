version: "3"

vars:
  SPHINXBUILD: sphinx-build
  SPHINX_AUTOBUILD: sphinx-autobuild
  SOURCEDIR: source
  BUILDDIR: build
  CDDL_FILE: source/specifications/fusain/fusain.cddl
  CDDL_TYPES: >-
    motor-config-payload pump-config-payload temp-config-payload glow-config-payload
    data-subscription-payload telemetry-config-payload timeout-config-payload
    state-command-payload motor-command-payload pump-command-payload glow-command-payload
    temp-command-payload send-telemetry-payload
    state-data-payload motor-data-payload pump-data-payload glow-data-payload
    temp-data-payload device-announce-payload ping-response-payload
    error-invalid-cmd-payload error-state-reject-payload

tasks:
  ci:
    desc: Build HTML documentation and validate CDDL schema
    cmds:
      - "{{.SPHINXBUILD}} -b html -W --keep-going {{.SOURCEDIR}} {{.BUILDDIR}}"
      - task: linkcheck
      - task: validate-cddl

  install:
    desc: Install Python dependencies from requirements.txt
    cmds:
      - pip install -r requirements.txt

  html:
    desc: Build HTML documentation
    cmds:
      - "{{.SPHINXBUILD}} -M html {{.SOURCEDIR}} {{.BUILDDIR}}"

  clean:
    desc: Clean build directory
    cmds:
      - "{{.SPHINXBUILD}} -M clean {{.SOURCEDIR}} {{.BUILDDIR}}"

  serve:
    desc: Build and serve documentation with auto-reload
    cmds:
      - "{{.SPHINX_AUTOBUILD}} {{.SOURCEDIR}} {{.BUILDDIR}}"

  linkcheck:
    desc: Check internal/external links
    cmds:
      - "{{.SPHINXBUILD}} -M linkcheck {{.SOURCEDIR}} {{.BUILDDIR}}"

  help:
    desc: Show Sphinx help
    cmds:
      - "{{.SPHINXBUILD}} -M help {{.SOURCEDIR}} {{.BUILDDIR}}"

  validate-cddl:
    desc: Validate the Fusain CDDL schema using zcbor
    sources:
      - "{{.CDDL_FILE}}"
    generates:
      - "{{.BUILDDIR}}/cddl/fusain.c"
      - "{{.BUILDDIR}}/cddl/fusain.h"
    cmds:
      - mkdir -p {{.BUILDDIR}}/cddl
      - zcbor code
        --cddl {{.CDDL_FILE}}
        --output-c {{.BUILDDIR}}/cddl/fusain.c
        --output-h {{.BUILDDIR}}/cddl/fusain.h
        -t {{.CDDL_TYPES}}
        --decode --encode
