;
; Copyright (c) 2025 Kaz Walker, Thermoquad
; SPDX-License-Identifier: Apache-2.0
;
; Fusain Protocol v3.0 - CBOR Schema (CDDL)
;
; This schema defines the CBOR-encoded payload format for Fusain v3.0.
;
; Wire format:
;   [START][LENGTH][ADDRESS(8)][CBOR_PAYLOAD][CRC(2)][END]
;
; Features:
;   - Schema-driven validation
;   - Optional fields without padding bytes
;   - Future extensibility (add fields without breaking compatibility)
;   - Self-describing format for debugging
;   - Generated encode/decode code via zcbor
;

; ===========================================================================
; Common Types
; ===========================================================================

; Timestamp in milliseconds since boot (wraps at 2^32)
timestamp = uint .size 4

; Device/peripheral index (0-9 typically)
device-index = uint .size 1

; 64-bit device address
address = uint .size 8

; ===========================================================================
; Enumerations
; ===========================================================================

; Operating modes (matches fusain_mode_t)
mode = &(
    mode-idle: 0,
    mode-fan: 1,
    mode-heat: 2,
    mode-emergency: 255,
)

; System states (matches fusain_state_t)
state = &(
    state-initializing: 0,
    state-idle: 1,
    state-blowing: 2,
    state-preheat: 3,
    state-preheat-stage-2: 4,
    state-heating: 5,
    state-cooling: 6,
    state-error: 7,
    state-e-stop: 8,
)

; Error codes (matches fusain_error_t)
error-code = &(
    error-none: 0,
    error-overheat: 1,
    error-sensor-fault: 2,
    error-ignition-fail: 3,
    error-flame-out: 4,
    error-motor-stall: 5,
    error-pump-fault: 6,
    error-commanded-estop: 7,
)

; Temperature command types
temp-cmd-type = &(
    temp-cmd-watch-motor: 0,
    temp-cmd-unwatch-motor: 1,
    temp-cmd-enable-rpm-control: 2,
    temp-cmd-disable-rpm-control: 3,
    temp-cmd-set-target-temp: 4,
)

; Pump event types
pump-event = &(
    pump-event-initializing: 0,
    pump-event-ready: 1,
    pump-event-error: 2,
    pump-event-cycle-start: 3,
    pump-event-pulse-end: 4,
    pump-event-cycle-end: 5,
)

; Telemetry types for SEND_TELEMETRY command
telemetry-type = &(
    telemetry-state: 0,
    telemetry-motor: 1,
    telemetry-temp: 2,
    telemetry-pump: 3,
    telemetry-glow: 4,
)

; ===========================================================================
; Message Types (first element of the CBOR message array)
; ===========================================================================

msg-type = &(
    ; Configuration Commands (Controller -> Appliance) 0x10-0x1F
    msg-motor-config: 0x10,
    msg-pump-config: 0x11,
    msg-temp-config: 0x12,
    msg-glow-config: 0x13,
    msg-data-subscription: 0x14,
    msg-data-unsubscribe: 0x15,
    msg-telemetry-config: 0x16,
    msg-timeout-config: 0x17,
    msg-discovery-request: 0x1F,

    ; Control Commands (Controller -> Appliance) 0x20-0x2F
    msg-state-command: 0x20,
    msg-motor-command: 0x21,
    msg-pump-command: 0x22,
    msg-glow-command: 0x23,
    msg-temp-command: 0x24,
    msg-send-telemetry: 0x25,
    msg-ping-request: 0x2F,

    ; Telemetry Data (Appliance -> Controller) 0x30-0x3F
    msg-state-data: 0x30,
    msg-motor-data: 0x31,
    msg-pump-data: 0x32,
    msg-glow-data: 0x33,
    msg-temp-data: 0x34,
    msg-device-announce: 0x35,
    msg-ping-response: 0x3F,

    ; Error Messages (Bidirectional) 0xE0-0xEF
    msg-error-invalid-cmd: 0xE0,
    msg-error-state-reject: 0xE1,
)

; ===========================================================================
; Top-Level Message Structure
; ===========================================================================

; All messages are encoded as: [type, payload]
; This allows efficient parsing: read type first, then decode appropriate payload

fusain-message = [
    type: msg-type,
    payload: message-payload,
]

; Union of all possible payloads based on message type
message-payload = (
    ; Configuration commands
    motor-config-payload /
    pump-config-payload /
    temp-config-payload /
    glow-config-payload /
    data-subscription-payload /
    telemetry-config-payload /
    timeout-config-payload /
    nil /  ; discovery-request has no payload

    ; Control commands
    state-command-payload /
    motor-command-payload /
    pump-command-payload /
    glow-command-payload /
    temp-command-payload /
    send-telemetry-payload /
    nil /  ; ping-request has no payload

    ; Telemetry data
    state-data-payload /
    motor-data-payload /
    pump-data-payload /
    glow-data-payload /
    temp-data-payload /
    device-announce-payload /
    ping-response-payload /

    ; Error messages
    error-invalid-cmd-payload /
    error-state-reject-payload
)

; ===========================================================================
; Configuration Command Payloads (0x10-0x1F)
; ===========================================================================

motor-config-payload = {
    0 => motor: device-index,           ; Motor index
    1 => pwm-period: uint,              ; PWM period in microseconds
    2 => pid-kp: float,                 ; PID proportional gain
    3 => pid-ki: float,                 ; PID integral gain
    4 => pid-kd: float,                 ; PID derivative gain
    5 => max-rpm: int,                  ; Maximum RPM
    6 => min-rpm: int,                  ; Minimum stable RPM
    ? 7 => min-pwm-duty: uint,          ; Minimum PWM duty (optional)
}

pump-config-payload = {
    0 => pump: device-index,            ; Pump index
    1 => pulse-ms: uint,                ; Pulse duration in ms
    2 => recovery-ms: uint,             ; Recovery time in ms
}

temp-config-payload = {
    0 => thermometer: device-index,     ; Thermometer index
    1 => pid-kp: float,                 ; PID proportional gain
    2 => pid-ki: float,                 ; PID integral gain
    3 => pid-kd: float,                 ; PID derivative gain
    ? 4 => sample-count: uint,          ; Number of samples to average
    ? 5 => read-rate: uint,             ; Read rate in Hz
}

glow-config-payload = {
    0 => glow: device-index,            ; Glow plug index
    1 => max-duration-ms: uint,         ; Maximum glow duration
}

data-subscription-payload = {
    0 => appliance-address: address,    ; Address of appliance to subscribe to
}

; data-unsubscribe uses same payload as data-subscription

telemetry-config-payload = {
    0 => enabled: bool,                 ; Telemetry broadcast enabled
    ? 1 => interval-ms: uint,           ; Broadcast interval (0 = polling mode)
}

timeout-config-payload = {
    0 => enabled: bool,                 ; Timeout enabled
    1 => timeout-ms: uint,              ; Timeout interval (5000-60000)
}

; discovery-request has no payload (nil)

; ===========================================================================
; Control Command Payloads (0x20-0x2F)
; ===========================================================================

state-command-payload = {
    0 => mode: mode,                    ; Target operating mode
    ? 1 => argument: int,               ; Mode-specific argument (RPM for FAN, rate for HEAT)
}

motor-command-payload = {
    0 => motor: device-index,           ; Motor index
    1 => rpm: int,                      ; Target RPM (0 = stop)
}

pump-command-payload = {
    0 => pump: device-index,            ; Pump index
    1 => rate-ms: int,                  ; Pulse interval in ms (0 = stop)
}

glow-command-payload = {
    0 => glow: device-index,            ; Glow plug index
    1 => duration: int,                 ; Burn duration in ms (0 = off)
}

temp-command-payload = {
    0 => thermometer: device-index,     ; Temperature controller index
    1 => type: temp-cmd-type,           ; Command type
    ? 2 => motor-index: device-index,   ; Motor to control (for WATCH_MOTOR)
    ? 3 => target-temp: float,          ; Target temperature (for SET_TARGET_TEMP)
}

send-telemetry-payload = {
    0 => type: telemetry-type,          ; Which telemetry to send
    ? 1 => index: uint,                 ; Peripheral index (0xFFFFFFFF = all)
}

; ping-request has no payload (nil)

; ===========================================================================
; Telemetry Data Payloads (0x30-0x3F)
; ===========================================================================

state-data-payload = {
    0 => error: bool,                   ; Error flag
    1 => code: error-code,              ; Error code
    2 => state: state,                  ; Current system state
    3 => timestamp: timestamp,          ; Timestamp in ms
}

motor-data-payload = {
    0 => motor: device-index,           ; Motor index
    1 => timestamp: timestamp,          ; Reading timestamp
    2 => rpm: int,                      ; Current measured RPM
    3 => target: int,                   ; Target RPM setpoint
    ? 4 => max-rpm: int,                ; Maximum achievable RPM
    ? 5 => min-rpm: int,                ; Minimum stable RPM
    ? 6 => pwm: int,                    ; Current PWM pulse width (us)
    ? 7 => pwm-max: int,                ; PWM period (us)
}

pump-data-payload = {
    0 => pump: device-index,            ; Pump index
    1 => timestamp: timestamp,          ; Event timestamp
    2 => event: pump-event,             ; Event type
    ? 3 => rate: int,                   ; Current pump rate (ms)
}

glow-data-payload = {
    0 => glow: device-index,            ; Glow plug index
    1 => timestamp: timestamp,          ; Status timestamp
    2 => lit: bool,                     ; Lit status
}

temp-data-payload = {
    0 => thermometer: device-index,     ; Thermometer index
    1 => timestamp: timestamp,          ; Reading timestamp
    2 => temp: float,                   ; Temperature in Celsius
    ? 3 => ctrl-rpm-by-temp: bool,      ; Temperature-based RPM control active
    ? 4 => watched-motor: int,          ; Motor being controlled (-1 = none)
    ? 5 => target-temp: float,          ; Target temperature for PID
}

device-announce-payload = {
    0 => motor-count: uint .size 1,     ; Number of motors
    1 => thermometer-count: uint .size 1, ; Number of temperature sensors
    2 => pump-count: uint .size 1,      ; Number of pumps
    3 => glow-count: uint .size 1,      ; Number of glow plugs
    ? 4 => version: tstr,               ; Firmware version (optional)
    ? 5 => capabilities: uint,          ; Capability flags (optional)
}

ping-response-payload = {
    0 => uptime-ms: timestamp,          ; System uptime in ms
}

; ===========================================================================
; Error Message Payloads (0xE0-0xEF)
; ===========================================================================

error-invalid-cmd-payload = {
    0 => error-code: int,               ; 1 = invalid param, 2 = invalid device index
    ? 1 => message: tstr,               ; Human-readable error (optional)
}

error-state-reject-payload = {
    0 => current-state: state,          ; State that rejected the command
    ? 1 => message: tstr,               ; Human-readable reason (optional)
}
